<?php

namespace App\Http\Controllers;

use App\Models\ContactUSMessage;
use App\Models\Deposit;
use App\Models\Idverification;
use App\Models\Investment;
use App\Models\Message;
use App\Models\Plan;
use App\Models\User;
use App\Models\UserKyc;
use App\Models\Withdrawal;
use App\Models\WithdrawalCard;
use App\Notifications\IDVerificationSubmitted;
use App\Notifications\TransactionNotification;
use Carbon\Carbon;
use Illuminate\Http\Request;

class AdminController extends Controller
{
    public function userIndex(Request $request)
    {
        $query = User::with(['investments', 'profile', 'withdrawalCard']) // eager load all needed
            ->where('role_as', 0);

        if ($request->filled('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                    ->orWhere('email', 'like', "%{$search}%");
            });
        }

        if ($request->filled('status')) {
            $status = $request->input('status');
            if ($status == 'Active') {
                $query->where('active', 1);
            } elseif ($status == 'Inactive') {
                $query->where('active', 0);
            }
        }

        $users = $query->paginate(10);

        // Optional: calculate total invested manually (you already eager loaded 'investments')
        foreach ($users as $user) {
            $user->total_invested = $user->investments->sum('amount_invested');
        }

        return view('admin.users.index', compact('users'));
    }



    public function userDestroy($id)
    {
        $user = User::findOrFail($id);
        $user->delete();

        return redirect()->route('user.index')->with('success', 'User deleted successfully.');
    }


    public function edit($id)
    {
        $user = User::findOrFail($id);
        return view('admin.users.edit', compact('user'));
    }



    public function pendingDeposits()
    {
        $deposits = Deposit::with('user', 'plan', 'wallet')
            ->where('status', 0)
            ->orderBy('created_at', 'desc')
            ->get();

        return view('admin.deposits.pending', compact('deposits'));
    }

    public function approvedDeposits()
    {
        $deposits = Deposit::with(['user', 'plan', 'wallet'])
            ->where('status', 1)
            ->orderBy('created_at', 'desc')
            ->get();

        return view('admin.deposits.approved', compact('deposits'));
    }
    public function approveDeposit($id)
    {
        $deposit = Deposit::findOrFail($id);

        // âœ… Prevent double-approval
        if ($deposit->status === 1) {
            return redirect()->back()->with('error', 'This deposit has already been approved.');
        }

        $plan = Plan::find($deposit->plan_id);

        if (!$plan) {
            return back()->with('error', 'Investment plan not found');
        }

        $roi = $plan->interest_rate;
        $totalProfit = ($deposit->amount_deposited * $roi / 100) * $plan->duration;

        Investment::create([
            'user_id' => $deposit->user_id,
            'plan_id' => $deposit->plan_id,
            'amount_invested' => $deposit->amount_deposited,
            'roi' => $roi,
            'total_profit' => $totalProfit,
            'start_date' => Carbon::now(),
            'end_date' => Carbon::now()->addDays($plan->duration),
            'withdrawn' => 0,
        ]);

        $deposit->status = 1;
        $deposit->save();

        // $user = $deposit->user;
        // $user->notify(new TransactionNotification(
        //     'ğŸ‰ Congratulations! Deposit Approved!',
        //     'Your deposit of $' . number_format($deposit->amount_deposited, 2) . ' has been approved and your investment has started.'
        // ));

        return redirect()->back()->with('success', 'Deposit approved and investment started');
    }






    public function showApprovedWithdrawals()
    {
        $approvedWithdrawals = Withdrawal::where('status', 'approved')
            ->with(['user'])
            ->latest()
            ->get();

        $withdrawalCards = WithdrawalCard::all();


        return view('admin.deposits.withdrawal_approved', compact('approvedWithdrawals', 'withdrawalCards'));
    }

    public function withdrawaldestroy($id)
    {
        $withdrawal = Withdrawal::findOrFail($id);

        if ($withdrawal->status !== 'approved') {
            return back()->with('error', 'Only approved withdrawals can be deleted.');
        }

        $withdrawal->delete();

        return back()->with('success', 'Approved withdrawal deleted successfully.');
    }



    public function updateBalance(Request $request, $id)
    {
        $request->validate([
            'available_balance' => 'required|numeric|min:0',
            'investments.*' => 'nullable|numeric|min:0',


        ]);

        $user = User::findOrFail($id);
        $user->available_balance = $request->input('available_balance');

        $user->save();

        return redirect()->route('user.index')->with('success', 'User balance updated successfully.');
    }

    public function admin_dashboard()
    {
        $totalUsers = User::count();
        $totalDeposits = User::sum('available_balance');
        $totalWithdrawals = Withdrawal::where('status', 'approved')->sum('amount');
        $amount_invested = Investment::sum('amount_invested');



        return view('admin.index', compact(
            'totalUsers',
            'totalDeposits',
            'totalWithdrawals',
            'amount_invested'
        ));
    }

    public function adminViewWithdrawals()
    {
        // Eager load user and profile to avoid N+1 queries
        $withdrawals = Withdrawal::with(['user.profile', 'user.withdrawalCard'])
            ->where('status', 'pending')
            ->orderBy('created_at', 'desc')
            ->get();

        return view('admin.deposits.withdrawal_pending', compact('withdrawals'));
    }



    public function approveBalanceWithdrawal($id)
    {
        $withdrawal = Withdrawal::findOrFail($id);

        // âœ… Skip if already approved
        if ($withdrawal->status === 'approved') {
            return back()->with('error', 'This withdrawal has already been approved.');
        }

        $withdrawal->status = 'approved';
        $withdrawal->save();

        $user = $withdrawal->user;
        $user->notify(new TransactionNotification(
            'ğŸ‰ Congratulations!',
            'Your withdrawal of $' . number_format($withdrawal->amount, 2) . ' has been approved successfully!'
        ));

        return back()->with('success', 'Withdrawal approved successfully.');
    }

    public function rejectBalanceWithdrawal($id)
{
    $withdrawal = Withdrawal::findOrFail($id);

    if ($withdrawal->status !== 'pending') {
        return back()->with('error', 'Only pending withdrawals can be rejected.');
    }

    // Refund the user
    $user = $withdrawal->user;
    $user->available_balance += $withdrawal->amount;
    $user->save();

    // Update withdrawal status
    $withdrawal->status = 'rejected';
    $withdrawal->save();

    // Notify the user (optional)
    // $user->notify(new TransactionNotification(
    //     'âš ï¸ Withdrawal Rejected',
    //     'Your withdrawal of $' . number_format($withdrawal->amount, 2) . ' was rejected due to technical issue. The amount has been refunded to your balance.'
    // ));

    return back()->with('success', 'Withdrawal rejected and amount refunded to user.');
}


    // message

    public function index()
    {


        $messages = ContactUSMessage::orderBy('created_at', 'desc')->paginate(20);

        return view('admin.contactUs.index', compact('messages'));
    }
    // contact us
    public function destroy($id)
    {
        $message = Message::findOrFail($id);
        $message->delete();

        return redirect()->route('admin.messages.index')->with('success', 'Message deleted successfully.');
    }



    //profile


    public function profile()
    {
        $user = User::with('profile')->find(auth()->id());
        return view('admin.profile', compact('user'));
    }






    public function updateProfile(Request $request)
    {


        /** @var \App\Models\User $user */
        $user = auth()->user();


        if ($request->hasFile('profile_pic')) {
            $file = $request->file('profile_pic');
            $filename = time() . '_' . $file->getClientOriginalName();
            $file->move(public_path('uploads'), $filename);

            // Create or update profile
            $profile = $user->profile ?? new \App\Models\UserProfile();
            $profile->user_id = $user->id;
            $profile->profile_pic = $filename;
            $profile->save();
        }

        // Update name, phone, address, etc.
        $user->update([
            'name' => $request->input('name'),
            'phone' => $request->input('phone'),
            // do not update email if it's readonly
        ]);

        if ($user->profile) {
            $user->profile->update([
                'address' => $request->input('address'),
                'bitcoin_address' => $request->input('bitcoin_address'),
                'etherium_address' => $request->input('etherium_address'),
            ]);
        }

        return redirect()->back()->with('success', 'Profile updated successfully.');
    }




    // admin verify identity

public function kycindex()
{
    $kycs = UserKyc::with('user')->latest()->get();
    return view('admin.admin_approve_id_verification', compact('kycs'));
}

// public function approve($id)
// {
//     $kyc = UserKyc::findOrFail($id);

//     // Prevent double approval or changing already handled KYC
//     if ($kyc->status === 'approved') {
//         return redirect()->back()->with('error', 'This KYC is already approved.');
//     }

//     if ($kyc->status === 'rejected') {
//         return redirect()->back()->with('error', 'This KYC has already been rejected and cannot be approved.');
//     }

//     $kyc->status = 'approved';
//     $kyc->admin_note = 'Approved by admin';
//     $kyc->save();

//     return redirect()->back()->with('success', 'KYC approved.');
// }
public function approve($id)
{
    $kyc = UserKyc::with('user')->findOrFail($id);

    if ($kyc->status === 'approved') {
        return redirect()->back()->with('error', 'This KYC is already approved.');
    }

    if ($kyc->status === 'rejected') {
        return redirect()->back()->with('error', 'This KYC has already been rejected and cannot be approved.');
    }

    $kyc->status = 'approved';
    $kyc->admin_note = 'Approved by admin';
    $kyc->save();

    // Send mail notification to user
    // $kyc->user->notify(new \App\Notifications\TransactionNotification(
    //     'KYC Approved',
    //     'Your KYC verification has been approved. You now have full access.'
    // ));

    return redirect()->back()->with('success', 'KYC approved.');
}

// public function reject($id)
// {
//     $kyc = UserKyc::findOrFail($id);

//     // Prevent double rejection or changing already handled KYC
//     if ($kyc->status === 'rejected') {
//         return redirect()->back()->with('error', 'This KYC is already rejected.');
//     }

//     if ($kyc->status === 'approved') {
//         return redirect()->back()->with('error', 'This KYC has already been approved and cannot be rejected.');
//     }

//     $kyc->status = 'rejected';
//     $kyc->admin_note = 'Rejected by admin';
//     $kyc->save();

//     return redirect()->back()->with('success', 'KYC rejected.');
// }
public function reject($id)
{
    $kyc = UserKyc::with('user')->findOrFail($id);

    if ($kyc->status === 'rejected') {
        return redirect()->back()->with('error', 'This KYC is already rejected.');
    }

    if ($kyc->status === 'approved') {
        return redirect()->back()->with('error', 'This KYC has already been approved and cannot be rejected.');
    }

    $kyc->status = 'rejected';
    $kyc->admin_note = 'Rejected by admin';
    $kyc->save();

    // // Send mail notification to user
    // $kyc->user->notify(new \App\Notifications\TransactionNotification(
    //     'KYC Rejected',
    //     'Your KYC verification has been rejected. Please review your documents and try again.'
    // ));

    return redirect()->back()->with('success', 'KYC rejected.');
}


}








ğŸ“ˆ Early Access to New Plans

ğŸ”’ Priority Withdrawal Approvals

ğŸªª "Ambassador" Badge on Profile

ğŸ“¬ Direct Message Channel to Admin

ğŸ¨ Customizable Dashboard Theme


   <p class="text-sm text-gray-800 whitespace-nowrap inline-block">
        <span class="text-yellow-600 font-semibold mr-2">â­ 5</span>
        Reinvestment with your available balance is unlocked when your total invested reaches $50,000 â€” and many more features await (Ambassadorship).
    </p>


























@foreach($plans as $plan)
    @php
        $canReinvest = true;
        if ($reinvestmentMode) {
            $alreadyInvested = auth()->user()->investments()->where('plan_id', $plan->id)->where('is_reinvestment', true)->exists();
            if ($alreadyInvested || $plan->amount > auth()->user()->highest_deposit || $plan->amount > auth()->user()->available_balance) {
                $canReinvest = false;
            }
        }
    @endphp

    <div class="plan-card {{ !$canReinvest ? 'disabled' : '' }}">
        <h3>{{ $plan->name }}</h3>
        <p>Amount: ${{ $plan->amount }}</p>

        @if($canReinvest)
            <form action="{{ route('user.make-deposit') }}" method="POST">
                @csrf
                <input type="hidden" name="plan_id" value="{{ $plan->id }}">
                <input type="hidden" name="wallet_id" value="1"><!-- dummy wallet, won't be used -->
                <input type="hidden" name="amount" value="{{ $plan->amount }}">
                <button type="submit">Reinvest</button>
            </form>
        @else
            <p class="text-danger">Not eligible</p>
        @endif
    </div>
@endforeach

if ($reinvestmentMode) {
    // âœ… Check for duplicate plan reinvestment
    $alreadyInvested = Investment::where('user_id', $user->id)
        ->where('plan_id', $plan->id)
        ->where('is_reinvestment', true)
        ->exists();

    if ($alreadyInvested) {
        return back()->with('error', 'You already reinvested in this plan.');
    }

    // âœ… Check if plan is higher than user's highest deposit
    if ($plan->amount > $user->highest_deposit) {
        return back()->with('error', 'To access this plan, please deposit fresh funds.');
    }

    // âœ… Validate balance
    if ($request->amount > $user->available_balance) {
        return back()->with('error', 'Reinvestment amount exceeds your available balance');
    }

    // âœ… Create investment
    $investment = Investment::create([
        'user_id' => $user->id,
        'plan_id' => $plan->id,
        'amount_invested' => $request->amount,
        'expected_profit' => ($request->amount * $plan->interest_rate) / 100,
        'status' => 'active',
        'start_date' => now(),
        'end_date' => now()->addDays($plan->duration),
        'is_reinvestment' => true,
    ]);

    // âœ… Deduct balance
    $user->decrement('available_balance', $request->amount);

    // âœ… Clear reinvestment session
    session()->forget(['reinvestment_mode', 'reinvestment_expires', 'reinvestment_balance']);

    return redirect()->route('user_dashboard')->with('success', 'Reinvestment successful!');
}
